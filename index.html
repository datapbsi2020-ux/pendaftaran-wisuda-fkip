<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Wisuda FKIP - Realtime Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.98); }
        
        /* Tampilan Khusus Cetak/Print */
        @media print {
            body * { visibility: hidden; }
            #previewSection, #previewSection * { visibility: visible; }
            #previewSection { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; box-shadow: none; }
            .no-print { display: none !important; }
            body { background: white; }
        }
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1e3a8a; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 min-h-screen text-gray-800">

    <!-- NAVBAR -->
    <nav class="bg-blue-900 text-white p-4 shadow-lg no-print">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="font-bold text-lg flex items-center gap-2">
                <i class="fas fa-graduation-cap text-yellow-400"></i> SIP-WISUDA FKIP (ONLINE)
            </div>
            <div class="space-x-4">
                <button onclick="showPage('inputSection')" class="hover:text-yellow-400 transition"><i class="fas fa-edit"></i> Daftar</button>
                <button onclick="checkLogin()" class="bg-yellow-500 text-blue-900 px-4 py-1 rounded font-bold hover:bg-yellow-400 transition"><i class="fas fa-user-shield"></i> Admin</button>
            </div>
        </div>
    </nav>

    <div class="py-10 px-4">
        
        <!-- HALAMAN 1: FORM INPUT -->
        <div id="inputSection" class="max-w-4xl mx-auto glass-card rounded-2xl shadow-2xl overflow-hidden bg-white transition-all duration-500">
            <div class="bg-blue-900 p-8 text-white text-center border-b-4 border-yellow-400">
                <h1 class="text-2xl font-bold uppercase tracking-wider mb-1">Formulir Pendaftaran Wisuda</h1>
                <h2 class="text-xl font-bold uppercase tracking-wide mb-1 text-yellow-400">Fakultas Keguruan dan Ilmu Pendidikan</h2>
                <h3 class="text-lg opacity-90 font-medium tracking-wide">Universitas Wiralodra</h3>
            </div>

            <form id="wisudaForm" class="p-8 md:p-10 space-y-6" onsubmit="handleSimpan(event)">
                <!-- Gelombang & Tahun -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-blue-50 p-5 rounded-xl border border-blue-100">
                    <div>
                        <label class="block text-xs font-bold text-blue-800 uppercase mb-1">Gelombang Wisuda</label>
                        <select id="input_gelombang" class="w-full border p-2 rounded bg-white"><option value="I">Gelombang I</option><option value="II" selected>Gelombang II</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-blue-800 uppercase mb-1">Tahun Akademik</label>
                        <select id="input_tahun" class="w-full border p-2 rounded bg-white"><option>2025</option><option>2026</option><option>2027</option><option>2028</option><option>2029</option><option>2030</option></select>
                    </div>
                </div>

                <!-- Input Data Diri -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-5">
                    <div class="space-y-4">
                        <h3 class="font-bold text-blue-800 border-b pb-1 uppercase text-sm italic">Identitas Mahasiswa</h3>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Nama Lengkap</label><input type="text" id="input_nama" class="w-full border-b py-2 outline-none focus:border-blue-600" required></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">NPM</label><input type="text" id="input_npm" class="w-full border-b py-2 outline-none focus:border-blue-600" required></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Prodi</label><select id="input_prodi" class="w-full border p-2 rounded mt-1"><option>Pendidikan Bahasa dan Sastra Indonesia</option><option>Pendidikan Bahasa Inggris</option><option>Pendidikan Matematika</option><option>Pendidikan Biologi</option></select></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500 uppercase">Kelas</label><select id="input_kelas" class="w-full border p-2 rounded"><option>Reguler</option><option>Nonreguler</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500 uppercase">Jenjang</label><select id="input_jenjang" class="w-full border p-2 rounded"><option>Sarjana</option><option>Magister</option></select></div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">TTL</label><input type="text" id="input_ttl" class="w-full border-b py-2 outline-none focus:border-blue-600" required></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Jenis Kelamin</label><div class="flex gap-4 mt-2"><label><input type="radio" name="jk" value="Laki-laki" checked> Laki-laki</label><label><input type="radio" name="jk" value="Perempuan"> Perempuan</label></div></div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="font-bold text-blue-800 border-b pb-1 uppercase text-sm italic">Kontak & Akademik</h3>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">NIK</label><input type="text" id="input_nik" class="w-full border-b py-2 outline-none focus:border-blue-600" required></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Nama Ibu</label><input type="text" id="input_ibu" class="w-full border-b py-2 outline-none focus:border-blue-600" required></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Email</label><input type="email" id="input_email" class="w-full border-b py-2 outline-none focus:border-blue-600" required></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">No. HP</label><input type="text" id="input_hp" class="w-full border-b py-2 outline-none focus:border-blue-600" required></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Tgl Lulus</label><input type="date" id="input_tgl_lulus" class="w-full border-b py-2 outline-none focus:border-blue-600" required></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500 uppercase">IPK</label><input type="number" step="0.01" id="input_ipk" class="w-full border-b py-2 outline-none focus:border-blue-600" required></div>
                            <div><label class="text-xs font-bold text-gray-500 uppercase">Yudisium</label><input type="text" id="input_yudisium" class="w-full border-b py-2 outline-none focus:border-blue-600"></div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Alamat</label><textarea id="input_alamat" class="w-full border-b py-2 outline-none h-10 resize-none"></textarea></div>
                    </div>
                </div>

                <!-- BAGIAN LAMPIRAN YANG DIPERBARUI -->
                <div class="bg-gray-50 p-6 rounded-xl border border-dashed border-gray-400 mt-6">
                    <h3 class="font-bold text-gray-800 mb-4 text-sm uppercase flex items-center gap-2">
                        <i class="fas fa-paperclip text-blue-900"></i> Persyaratan Lampiran:
                    </h3>
                    <div class="space-y-4 text-sm text-gray-700">
                        <!-- File 1 -->
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 border-b pb-2">
                            <label class="font-medium text-gray-700">1) Fotokopi Ijazah Terakhir (Legalisir)</label>
                            <input type="file" id="file_ijazah" class="text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                        </div>
                        <!-- File 2 -->
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 border-b pb-2">
                            <label class="font-medium text-gray-700">2) Fotokopi KTP</label>
                            <input type="file" id="file_ktp" class="text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                        </div>
                        <!-- File 3 -->
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 border-b pb-2">
                            <label class="font-medium text-gray-700">3) Surat Bebas Biaya Pendidikan</label>
                            <input type="file" id="file_bebas" class="text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                        </div>
                        <!-- File 4 -->
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-2">
                            <label class="font-medium text-gray-700">4) Sertifikat PKKMB</label>
                            <input type="file" id="file_pkkmb" class="text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                        </div>
                    </div>
                    <p class="text-xs text-red-500 mt-2 italic">* Pastikan file yang diunggah dapat terbaca dengan jelas.</p>
                </div>

                <div class="pt-6 flex flex-col items-center">
                    <div id="loadingSimpan" class="hidden mb-2 text-blue-900 font-bold"><div class="loader mr-2"></div>Mengirim Data...</div>
                    <button type="submit" id="btnSimpan" class="bg-blue-900 text-white px-12 py-3 rounded-full font-bold hover:bg-blue-800 shadow-lg uppercase tracking-widest text-sm transition transform hover:-translate-y-1">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> Simpan Permanen & Preview
                    </button>
                </div>
            </form>
        </div>

        <!-- HALAMAN 2: PREVIEW -->
        <div id="previewSection" class="hidden max-w-4xl mx-auto bg-white p-12 shadow-2xl min-h-screen relative">
            <div class="text-center border-b-2 border-black pb-4 mb-8">
                <h1 class="text-xl font-bold uppercase">Formulir Pendaftaran Wisuda</h1>
                <h2 class="text-lg font-bold uppercase">Fakultas Keguruan dan Ilmu Pendidikan</h2>
                <h3 class="text-lg font-medium">Universitas Wiralodra</h3>
                <p class="text-sm mt-2">Gelombang <span id="prev_gelombang" class="font-bold"></span> Tahun <span id="prev_tahun" class="font-bold"></span></p>
            </div>
            <table class="w-full text-sm leading-8">
                <tr><td class="w-1/3 font-bold">Nama Lengkap</td><td class="w-2">:</td><td id="prev_nama" class="uppercase"></td></tr>
                <tr><td class="font-bold">NPM</td><td>:</td><td id="prev_npm"></td></tr>
                <tr><td class="font-bold">Prodi</td><td>:</td><td id="prev_prodi"></td></tr>
                <tr><td class="font-bold">Kelas / Jenjang</td><td>:</td><td><span id="prev_kelas"></span> / <span id="prev_jenjang"></span></td></tr>
                <tr><td class="font-bold">TTL</td><td>:</td><td id="prev_ttl"></td></tr>
                <tr><td class="font-bold">Jenis Kelamin</td><td>:</td><td id="prev_jk"></td></tr>
                <tr><td class="font-bold">NIK</td><td>:</td><td id="prev_nik"></td></tr>
                <tr><td class="font-bold">Nama Ibu</td><td>:</td><td id="prev_ibu"></td></tr>
                <tr><td class="font-bold">Alamat</td><td>:</td><td id="prev_alamat"></td></tr>
                <tr><td class="font-bold">Kontak</td><td>:</td><td><span id="prev_email"></span> / <span id="prev_hp"></span></td></tr>
                <tr><td class="font-bold">Kelulusan</td><td>:</td><td>Lulus: <span id="prev_tgl_lulus"></span> (IPK: <span id="prev_ipk"></span>)</td></tr>
            </table>
            
            <!-- Preview Lampiran (Checklist Otomatis) -->
            <div class="mt-8 border border-black p-4">
                <p class="font-bold mb-2 text-sm uppercase">Status Dokumen Lampiran:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 text-sm gap-2">
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 border border-black flex items-center justify-center font-bold text-green-700" id="check_ijazah"></div> 
                        <span>Ijazah Legalisir</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 border border-black flex items-center justify-center font-bold text-green-700" id="check_ktp"></div> 
                        <span>Fotokopi KTP</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 border border-black flex items-center justify-center font-bold text-green-700" id="check_bebas"></div> 
                        <span>Surat Bebas Biaya</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-5 h-5 border border-black flex items-center justify-center font-bold text-green-700" id="check_pkkmb"></div> 
                        <span>Sertifikat PKKMB</span>
                    </div>
                </div>
            </div>

            <div class="mt-12 flex justify-end">
                <div class="text-center w-64">
                    <p class="text-sm">Indramayu, <span id="prev_tanggal_cetak"></span></p>
                    <p class="text-sm font-bold mb-20">Pendaftar,</p>
                    <div class="border-b border-black"></div>
                    <p class="text-xs mt-1 text-gray-500">( Tanda Tangan Mahasiswa )</p>
                </div>
            </div>
            <div class="mt-10 flex gap-4 justify-center no-print">
                <button onclick="window.print()" class="bg-blue-900 text-white px-6 py-2 rounded font-bold shadow-lg">Cetak PDF</button>
                <button onclick="window.location.reload()" class="bg-green-600 text-white px-6 py-2 rounded font-bold shadow-lg">Selesai</button>
            </div>
        </div>

        <!-- HALAMAN 3: ADMIN PANEL (Realtime) -->
        <div id="adminSection" class="hidden max-w-6xl mx-auto glass-card rounded-2xl shadow-2xl p-8 bg-white mt-4">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-bold text-blue-900"><i class="fas fa-server"></i> Database Pendaftar Realtime</h2>
                <button onclick="logoutAdmin()" class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700">Logout</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-blue-900 text-white">
                        <tr>
                            <th class="py-2 px-4 border">Waktu</th>
                            <th class="py-2 px-4 border">NPM</th>
                            <th class="py-2 px-4 border">Nama Lengkap</th>
                            <th class="py-2 px-4 border">Prodi</th>
                            <th class="py-2 px-4 border">Berkas</th>
                            <th class="py-2 px-4 border">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody" class="text-sm text-center text-gray-700">
                        <tr><td colspan="6" class="py-8"><div class="loader inline-block"></div> Menghubungkan Server...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // =========================================================================
        // --- 1. KONFIGURASI FIREBASE ---
        // =========================================================================
        
        // PASTE KODE CONFIG ANDA DI SINI (Timpa yang lama)
        const firebaseConfig = {
            apiKey: "AIzaSyC9FbDnb2qRSBOOrp-iVdCk5yQDHr9QAKw",
            authDomain: "wisudafkip-9bf28.firebaseapp.com",
            databaseURL: "https://wisudafkip-9bf28-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wisudafkip-9bf28",
            storageBucket: "wisudafkip-9bf28.firebasestorage.app",
            messagingSenderId: "528206555265",
            appId: "1:528206555265:web:0e0df4d93fd0db58e68580"
            measurementId: "G-NW845QP4VR"
        };
        // =========================================================================

        // --- 2. INISIALISASI ---
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase Connected");
        } catch (e) {
            console.error("Firebase Error: Belum disetting. " + e);
        }

        // --- 3. NAVIGASI ---
        function showPage(pageId) {
            document.querySelectorAll('#inputSection, #previewSection, #adminSection').forEach(el => el.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // --- 4. SIMPAN DATA (KE SERVER FIREBASE) ---
        function handleSimpan(e) {
            e.preventDefault();
            
            if (!db) { alert("ERROR: Database belum dikonfigurasi! Edit file HTML ini dan masukkan Config Firebase."); return; }

            document.getElementById('btnSimpan').classList.add('hidden');
            document.getElementById('loadingSimpan').classList.remove('hidden');

            // Cek Apakah File Dilampirkan (True/False)
            const hasIjazah = document.getElementById('file_ijazah').files.length > 0;
            const hasKtp = document.getElementById('file_ktp').files.length > 0;
            const hasBebas = document.getElementById('file_bebas').files.length > 0;
            const hasPkkmb = document.getElementById('file_pkkmb').files.length > 0;

            const id = Date.now(); 
            const formData = {
                id: id,
                tgl_input: new Date().toLocaleString('id-ID'),
                gelombang: document.getElementById('input_gelombang').value,
                tahun: document.getElementById('input_tahun').value,
                nama: document.getElementById('input_nama').value,
                npm: document.getElementById('input_npm').value,
                prodi: document.getElementById('input_prodi').value,
                kelas: document.getElementById('input_kelas').value,
                jenjang: document.getElementById('input_jenjang').value,
                ttl: document.getElementById('input_ttl').value,
                jk: document.querySelector('input[name="jk"]:checked').value,
                nik: document.getElementById('input_nik').value,
                ibu: document.getElementById('input_ibu').value,
                email: document.getElementById('input_email').value,
                hp: document.getElementById('input_hp').value,
                tgl_lulus: document.getElementById('input_tgl_lulus').value,
                ipk: document.getElementById('input_ipk').value,
                yudisium: document.getElementById('input_yudisium').value,
                alamat: document.getElementById('input_alamat').value,
                // Status Lampiran
                lampiran: {
                    ijazah: hasIjazah,
                    ktp: hasKtp,
                    bebas: hasBebas,
                    pkkmb: hasPkkmb
                }
            };

            // Kirim ke Firebase
            db.ref('pendaftar/' + id).set(formData)
            .then(() => {
                isiPreview(formData);
                showPage('previewSection');
                alert('Sukses! Data tersimpan di Server Admin.');
            })
            .catch((error) => {
                alert('Gagal menyimpan: ' + error.message);
                document.getElementById('btnSimpan').classList.remove('hidden');
            })
            .finally(() => {
                document.getElementById('loadingSimpan').classList.add('hidden');
            });
        }

        function isiPreview(data) {
            // Data Teks
            document.getElementById('prev_gelombang').innerText = data.gelombang;
            document.getElementById('prev_tahun').innerText = data.tahun;
            document.getElementById('prev_nama').innerText = data.nama;
            document.getElementById('prev_npm').innerText = data.npm;
            document.getElementById('prev_prodi').innerText = data.prodi;
            document.getElementById('prev_kelas').innerText = data.kelas;
            document.getElementById('prev_jenjang').innerText = data.jenjang;
            document.getElementById('prev_ttl').innerText = data.ttl;
            document.getElementById('prev_jk').innerText = data.jk;
            document.getElementById('prev_nik').innerText = data.nik;
            document.getElementById('prev_ibu').innerText = data.ibu;
            document.getElementById('prev_alamat').innerText = data.alamat;
            document.getElementById('prev_email').innerText = data.email;
            document.getElementById('prev_hp').innerText = data.hp;
            document.getElementById('prev_tgl_lulus').innerText = data.tgl_lulus;
            document.getElementById('prev_ipk').innerText = data.ipk;
            document.getElementById('prev_tanggal_cetak').innerText = new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});

            // Data Checklist Lampiran (Muncul Centang Jika Ada)
            document.getElementById('check_ijazah').innerText = data.lampiran.ijazah ? "✓" : "✗";
            document.getElementById('check_ktp').innerText = data.lampiran.ktp ? "✓" : "✗";
            document.getElementById('check_bebas').innerText = data.lampiran.bebas ? "✓" : "✗";
            document.getElementById('check_pkkmb').innerText = data.lampiran.pkkmb ? "✓" : "✗";
        }

        // --- 5. ADMIN ---
        function checkLogin() {
            const pass = prompt("Masukkan Password Admin:");
            if (pass === "admin123") {
                showPage('adminSection');
                loadRealtimeData();
            } else if (pass !== null) {
                alert("Password Salah!");
            }
        }

        function logoutAdmin() { showPage('inputSection'); }

        function loadRealtimeData() {
            if (!db) return;
            const tableBody = document.getElementById('adminTableBody');
            
            db.ref('pendaftar').on('value', (snapshot) => {
                tableBody.innerHTML = ''; 
                const data = snapshot.val();
                
                if (data) {
                    const dataArray = Object.values(data).reverse();
                    dataArray.forEach(item => {
                        // Hitung jumlah berkas
                        let berkasCount = 0;
                        if(item.lampiran && item.lampiran.ijazah) berkasCount++;
                        if(item.lampiran && item.lampiran.ktp) berkasCount++;
                        if(item.lampiran && item.lampiran.bebas) berkasCount++;
                        if(item.lampiran && item.lampiran.pkkmb) berkasCount++;

                        const row = `
                            <tr class="hover:bg-gray-50 border-b">
                                <td class="py-2 px-4 border text-xs">${item.tgl_input}</td>
                                <td class="py-2 px-4 border font-bold">${item.npm}</td>
                                <td class="py-2 px-4 border text-left">${item.nama}</td>
                                <td class="py-2 px-4 border text-left">${item.prodi}</td>
                                <td class="py-2 px-4 border text-sm font-bold text-blue-800">${berkasCount}/4 File</td>
                                <td class="py-2 px-4 border">
                                    <button onclick="hapusData(${item.id})" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition"><i class="fas fa-trash"></i> Hapus</button>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="py-8 text-gray-500">Belum ada data pendaftar.</td></tr>';
                }
            });
        }

        function hapusData(id) {
            if(confirm("Yakin ingin menghapus data ini dari server?")) {
                db.ref('pendaftar/' + id).remove();
            }
        }
    </script>
</body>
</html>

