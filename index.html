<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Wisuda FKIP - Universitas Wiralodra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.98); }
        .glass-dashboard { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.3); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #1e3a8a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .glass-card { box-shadow: none; border: none; width: 100%; margin: 0; padding: 0; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-slate-800 to-black min-h-screen text-gray-800 py-10 px-4">

    <!-- NAVBAR -->
    <nav class="bg-blue-900/90 backdrop-blur text-white p-4 shadow-lg no-print fixed top-0 w-full z-50 border-b border-white/10">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="font-bold text-lg flex items-center gap-2">
                <i class="fas fa-graduation-cap text-yellow-400"></i> SIP-WISUDA FKIP
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="showPage('inputSection')" class="hover:text-yellow-400 transition font-medium flex items-center gap-1">
                    <i class="fas fa-edit"></i> Daftar
                </button>
                <button onclick="checkLogin()" class="bg-yellow-500 text-blue-900 px-4 py-1 rounded font-bold hover:bg-yellow-400 transition cursor-pointer shadow-md border-2 border-yellow-600 text-sm flex items-center gap-1">
                    <i class="fas fa-user-shield"></i> Admin
                </button>
            </div>
        </div>
    </nav>

    <div class="h-16 no-print"></div>

    <!-- HALAMAN 1: FORM INPUT -->
    <div id="inputSection" class="max-w-4xl mx-auto glass-card rounded-2xl shadow-2xl overflow-hidden bg-white mt-4 transition-all duration-500">
        <div class="bg-blue-900 p-8 text-white text-center border-b-4 border-yellow-400">
            <div class="overflow-hidden w-full">
                <marquee direction="left" scrollamount="8" behavior="scroll" class="text-2xl font-bold uppercase tracking-wider mb-1">
                    Formulir Pendaftaran Wisuda
                </marquee>
            </div>
            <h2 class="text-xl font-bold uppercase tracking-wide mb-1 text-yellow-400">Fakultas Keguruan dan Ilmu Pendidikan</h2>
            <h3 class="text-lg opacity-90 font-medium tracking-wide">Universitas Wiralodra</h3>
        </div>

        <form id="wisudaForm" class="p-8 md:p-10 space-y-6" onsubmit="handleSimpan(event)">
            <!-- Gelombang & Tahun -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-blue-50 p-5 rounded-xl border border-blue-100">
                <div>
                    <label class="block text-xs font-bold text-blue-800 uppercase mb-1">Gelombang Wisuda</label>
                    <select id="input_gelombang" class="w-full border p-2 rounded bg-white outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="I">Gelombang I</option>
                        <option value="II" selected>Gelombang II</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-blue-800 uppercase mb-1">Tahun Akademik</label>
                    <select id="input_tahun" class="w-full border p-2 rounded bg-white outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option>2025</option>
                        <option>2026</option>
                        <option>2027</option>
                        <option>2028</option>
                        <option>2029</option>
                        <option>2030</option>
                    </select>
                </div>
            </div>

            <!-- Data Diri -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-5">
                <div class="space-y-4">
                    <h3 class="font-bold text-blue-800 border-b pb-1 uppercase text-sm italic">Identitas Mahasiswa</h3>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Nama Lengkap</label><input type="text" id="input_nama" class="w-full border-b py-2 focus:border-blue-600 outline-none" required placeholder="Sesuai Ijazah"></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">NPM</label><input type="text" id="input_npm" class="w-full border-b py-2 focus:border-blue-600 outline-none" required></div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Program Studi</label>
                        <select id="input_prodi" class="w-full border p-2 rounded mt-1 bg-gray-50 focus:bg-white" required>
                            <option>Pendidikan Bahasa dan Sastra Indonesia</option>
                            <option>Pendidikan Bahasa Inggris</option>
                            <option>Pendidikan Matematika</option>
                            <option>Pendidikan Biologi</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Kelas</label><select id="input_kelas" class="w-full border p-2 rounded mt-1"><option>Reguler</option><option>Nonreguler</option></select></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Jenjang</label><select id="input_jenjang" class="w-full border p-2 rounded mt-1"><option>Sarjana</option><option>Magister</option></select></div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Tempat, Tanggal Lahir</label><input type="text" id="input_ttl" class="w-full border-b py-2 focus:border-blue-600 outline-none" required placeholder="Contoh: Indramayu, 01 Jan 2000"></div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Jenis Kelamin</label>
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="jk" value="Laki-laki" checked> Laki-laki</label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="jk" value="Perempuan"> Perempuan</label>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="font-bold text-blue-800 border-b pb-1 uppercase text-sm italic">Kontak & Keluarga</h3>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">NIK (Sesuai KTP)</label><input type="text" id="input_nik" class="w-full border-b py-2 focus:border-blue-600 outline-none" required maxlength="16"></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Nama Ibu Kandung</label><input type="text" id="input_ibu" class="w-full border-b py-2 focus:border-blue-600 outline-none" required></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Email</label><input type="email" id="input_email" class="w-full border-b py-2 focus:border-blue-600 outline-none" required></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">No. HP/WhatsApp</label><input type="text" id="input_hp" class="w-full border-b py-2 focus:border-blue-600 outline-none" required></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Tanggal Kelulusan</label><input type="date" id="input_tgl_lulus" class="w-full border-b py-2 focus:border-blue-600 outline-none" required></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-gray-500 uppercase">IPK</label><input type="number" step="0.01" id="input_ipk" class="w-full border-b py-2 focus:border-blue-600 outline-none" required placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Yudisium</label><input type="text" id="input_yudisium" class="w-full border-b py-2 focus:border-blue-600 outline-none" placeholder="Sangat Memuaskan"></div>
                    </div>
                </div>
            </div>

            <div><label class="text-xs font-bold text-gray-500 uppercase">Alamat Rumah Lengkap</label><textarea id="input_alamat" class="w-full border-b py-2 focus:border-blue-600 outline-none h-16 resize-none" required></textarea></div>

            <!-- Upload Lampiran -->
            <div class="bg-gray-50 p-6 rounded-xl border border-dashed border-gray-400 mt-6">
                <h3 class="font-bold text-gray-800 mb-4 text-sm uppercase flex items-center gap-2">
                    <i class="fas fa-paperclip text-blue-900"></i> Unggah Lampiran (Wajib):
                </h3>
                <div class="space-y-4 text-sm text-gray-700">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 border-b pb-2">
                        <span class="font-medium">1) Ijazah Terakhir (Legalisir)</span>
                        <input type="file" id="file_ijazah" accept=".pdf,.jpg,.jpeg,.png" class="text-xs">
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 border-b pb-2">
                        <span class="font-medium">2) KTP</span>
                        <input type="file" id="file_ktp" accept=".pdf,.jpg,.jpeg,.png" class="text-xs">
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 border-b pb-2">
                        <span class="font-medium">3) Surat Bebas Biaya</span>
                        <input type="file" id="file_bebas" accept=".pdf,.jpg,.jpeg,.png" class="text-xs">
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 border-b pb-2">
                        <span class="font-medium">4) Sertifikat PKKMB</span>
                        <input type="file" id="file_pkkmb" accept=".pdf,.jpg,.jpeg,.png" class="text-xs">
                    </div>
                </div>
                <p class="text-[10px] text-red-500 mt-2 italic">* Mohon tunggu proses upload (30-60 detik tergantung sinyal).</p>
            </div>

            <div class="pt-6 flex flex-col items-center">
                <div id="loading" class="hidden mb-3 text-blue-900 font-bold flex items-center gap-2 bg-blue-100 px-4 py-2 rounded-lg">
                    <div class="loader"></div> <span id="loadingMsg">Sedang memproses data...</span>
                </div>
                <button type="submit" id="btnSubmit" class="bg-blue-900 text-white px-12 py-4 rounded-full font-bold hover:bg-blue-800 shadow-lg uppercase tracking-widest text-sm transition transform hover:-translate-y-1 w-full md:w-auto">
                    <i class="fas fa-paper-plane mr-2"></i> Kirim Pendaftaran
                </button>
            </div>
        </form>
    </div>

    <!-- HALAMAN 2: ADMIN DASHBOARD (ELEGANT VIEW) -->
    <div id="adminSection" class="hidden max-w-6xl mx-auto mt-4">
        <!-- Header Dashboard -->
        <div class="glass-dashboard rounded-3xl p-8 mb-8 text-center md:text-left flex flex-col md:flex-row justify-between items-center shadow-2xl">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Dashboard Admin</h1>
                <p class="text-slate-600 mt-2">Kelola Data Pendaftar Wisuda Secara Realtime</p>
            </div>
            
            <div class="mt-4 md:mt-0 flex gap-3">
                <!-- Tombol 1: Database Mentah -->
                <button onclick="window.open(SPREADSHEET_URL, '_blank')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2">
                    <i class="fas fa-table"></i> Buka Excel (Spreadsheet)
                </button>
                <button onclick="logoutAdmin()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition">
                    Logout
                </button>
            </div>
        </div>

        <!-- Tombol 2: Tampilan Visual (Hasil yang Elegan) -->
        <div class="grid grid-cols-1 gap-6" id="dataContainer">
            <!-- Loading State -->
            <div class="text-center py-20 bg-white/10 rounded-3xl backdrop-blur">
                <div class="loader w-10 h-10 border-4 border-white border-t-blue-500"></div>
                <p class="text-white mt-4 font-medium">Mengambil Data Terbaru dari Server...</p>
            </div>
        </div>
    </div>

    <!-- PREVIEW -->
    <div id="previewSection" class="hidden max-w-4xl mx-auto bg-white p-12 shadow-2xl min-h-screen relative rounded-xl mt-4">
        <div class="text-center border-b-2 border-black pb-4 mb-8">
            <h1 class="text-xl font-bold uppercase">Bukti Pendaftaran Wisuda</h1>
            <h2 class="text-lg font-bold uppercase text-blue-900">FKIP Universitas Wiralodra</h2>
            <p class="text-sm mt-2">Data Telah Tersimpan di Database Fakultas</p>
        </div>
        <div id="previewContent"></div>
        <div class="mt-10 flex flex-col md:flex-row gap-4 justify-center no-print">
            <button onclick="window.print()" class="bg-blue-900 text-white px-8 py-3 rounded-lg font-bold shadow hover:bg-blue-800 transition"><i class="fas fa-print mr-2"></i> Cetak Bukti</button>
            <button onclick="window.location.reload()" class="bg-green-600 text-white px-8 py-3 rounded-lg font-bold shadow hover:bg-green-700 transition"><i class="fas fa-plus mr-2"></i> Daftar Baru</button>
        </div>
    </div>

    <script>
        // ==========================================================
        // GANTI DENGAN URL WEB APP TERBARU ANDA
        // ==========================================================
        const SCRIPT_URL = "MASUKKAN_URL_WEB_APP_ANDA_DISINI";
        const SPREADSHEET_URL = "MASUKKAN_LINK_GOOGLE_SHEET_DISINI";
        // ==========================================================

        // --- FUNGSI ADMIN ---
        function checkLogin() {
            const pass = prompt("Masukkan Password Admin:");
            if (pass === "admin123") {
                showPage('adminSection');
                loadAdminData(); // Ambil data saat login berhasil
            } else if (pass !== null) {
                alert("Password Salah!");
            }
        }

        function logoutAdmin() {
            showPage('inputSection');
        }

        // --- FUNGSI LOAD DATA ADMIN (GET) ---
        async function loadAdminData() {
            const container = document.getElementById('dataContainer');
            
            try {
                // Panggil Script dengan mode GET (Default fetch tanpa method POST adalah GET)
                // Pastikan Apps Script Anda sudah memiliki fungsi doGet() yang saya berikan sebelumnya
                const response = await fetch(SCRIPT_URL);
                const json = await response.json();

                if(json.status === "success") {
                    if(json.data.length === 0) {
                        container.innerHTML = `<div class="text-center text-white py-10">Belum ada data pendaftar.</div>`;
                        return;
                    }

                    let html = '';
                    // Loop data dan buat Kartu Elegan
                    json.data.forEach(item => {
                        html += `
                        <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center hover:transform hover:scale-[1.01] transition duration-300">
                            <div class="flex items-center gap-4 mb-4 md:mb-0">
                                <div class="bg-blue-100 text-blue-600 w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl shadow-sm">
                                    ${item.nama.charAt(0)}
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg text-gray-800 uppercase">${item.nama}</h4>
                                    <div class="flex flex-wrap gap-2 text-sm text-gray-500 mt-1">
                                        <span class="bg-gray-100 px-2 py-1 rounded">NPM: ${item.npm}</span>
                                        <span class="bg-gray-100 px-2 py-1 rounded">${item.prodi}</span>
                                        <span class="bg-gray-100 px-2 py-1 rounded"><i class="fas fa-phone-alt text-xs"></i> ${item.hp}</span>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-2">Mendaftar: ${new Date(item.waktu).toLocaleString('id-ID')}</div>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 w-full md:w-auto">
                                <a href="${item.link_folder}" target="_blank" class="flex-1 md:flex-none text-center bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-medium transition text-sm">
                                    <i class="fas fa-folder-open mr-1"></i> Lihat Berkas
                                </a>
                            </div>
                        </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `<div class="text-center text-red-300 py-10">Gagal memuat data: ${json.message}</div>`;
                }

            } catch (err) {
                console.error(err);
                container.innerHTML = `
                    <div class="text-center bg-white/10 p-8 rounded-2xl backdrop-blur text-white">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3 text-yellow-300"></i><br>
                        Gagal mengambil data.<br>
                        <span class="text-sm opacity-70">Pastikan Anda sudah mengupdate "Kode Apps Script" dengan fungsi doGet() yang baru.</span>
                    </div>`;
            }
        }

        // --- FUNGSI SIMPAN (Frontend sama seperti sebelumnya) ---
        // Fungsi Kompresi File
        const processFile = (file) => new Promise((resolve, reject) => {
            if (!file) { resolve(""); return; }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                if (file.type.startsWith('image/')) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 1000; 
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                    };
                } else {
                    resolve(event.target.result);
                }
            };
            reader.onerror = error => reject(error);
        });

        async function handleSimpan(e) {
            e.preventDefault();
            
            if (SCRIPT_URL.includes("MASUKKAN_URL")) { alert("Error: URL Script belum dimasukkan!"); return; }

            document.getElementById('btnSubmit').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loadingMsg').innerText = "Mengompres berkas...";

            try {
                const [ijazahB64, ktpB64, bebasB64, pkkmbB64] = await Promise.all([
                    processFile(document.getElementById('file_ijazah').files[0]),
                    processFile(document.getElementById('file_ktp').files[0]),
                    processFile(document.getElementById('file_bebas').files[0]),
                    processFile(document.getElementById('file_pkkmb').files[0])
                ]);

                const payload = {
                    gelombang: document.getElementById('input_gelombang').value,
                    tahun: document.getElementById('input_tahun').value,
                    nama: document.getElementById('input_nama').value,
                    npm: document.getElementById('input_npm').value,
                    prodi: document.getElementById('input_prodi').value,
                    kelas: document.getElementById('input_kelas').value,
                    jenjang: document.getElementById('input_jenjang').value,
                    ttl: document.getElementById('input_ttl').value,
                    jk: document.querySelector('input[name="jk"]:checked').value,
                    nik: document.getElementById('input_nik').value,
                    ibu: document.getElementById('input_ibu').value,
                    email: document.getElementById('input_email').value,
                    hp: document.getElementById('input_hp').value,
                    tgl_lulus: document.getElementById('input_tgl_lulus').value,
                    ipk: document.getElementById('input_ipk').value,
                    yudisium: document.getElementById('input_yudisium').value,
                    alamat: document.getElementById('input_alamat').value,
                    files: { ijazah: ijazahB64, ktp: ktpB64, bebas: bebasB64, pkkmb: pkkmbB64 }
                };

                document.getElementById('loadingMsg').innerText = "Mengirim data ke server...";

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.status === "success") {
                    showPreview(payload);
                    alert("Berhasil! Data Anda sudah tersimpan.");
                } else {
                    throw new Error(result.message);
                }

            } catch (err) {
                console.error(err);
                alert("Gagal Mengirim: " + err.message + "\n\nTips: File PDF jangan terlalu besar.");
                document.getElementById('btnSubmit').classList.remove('hidden');
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function showPreview(data) {
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('previewSection').classList.remove('hidden');
            
            let html = `
                <table class="w-full text-sm leading-8 mt-5 border-collapse">
                    <tr class="border-b"><td class="w-1/3 font-bold py-1">Nama Lengkap</td><td>: <span class="uppercase">${data.nama}</span></td></tr>
                    <tr class="border-b"><td class="font-bold py-1">NPM</td><td>: ${data.npm}</td></tr>
                    <tr class="border-b"><td class="font-bold py-1">Program Studi</td><td>: ${data.prodi}</td></tr>
                    <tr class="border-b"><td class="font-bold py-1">Waktu Daftar</td><td>: ${new Date().toLocaleString('id-ID')}</td></tr>
                </table>
                <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 text-sm flex items-start gap-3">
                    <i class="fas fa-check-circle text-xl mt-1"></i>
                    <div>
                        <strong>Pendaftaran Berhasil!</strong><br>
                        Data telah tercatat dan berkas lampiran telah tersimpan di Google Drive.
                    </div>
                </div>
            `;
            document.getElementById('previewContent').innerHTML = html;
            window.scrollTo(0,0);
        }

        function showPage(id) { 
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>
